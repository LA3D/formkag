# document_extraction


<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->

``` python
from IPython.display import Markdown, Image, display
```

## Data container definitions

------------------------------------------------------------------------

<a
href="https://github.com/la3d/formkag/blob/main/cosma/document_extraction.py#L18"
target="_blank" style="float:right; font-size:smaller">source</a>

### Region

>  Region (id:str, name:str, type:str, order:int, position:str,
>              bounds:str='', next_regions:List[str]=<factory>,
>              contains:List[str]=<factory>)

*A region represents a distinct area in a document with specific content
and purpose*

------------------------------------------------------------------------

<a
href="https://github.com/la3d/formkag/blob/main/cosma/document_extraction.py#L38"
target="_blank" style="float:right; font-size:smaller">source</a>

### SpatialRel

>  SpatialRel (from_region:str, to_region:str, relationship:str)

*Describes how regions are spatially related to each other in the
document*

------------------------------------------------------------------------

<a
href="https://github.com/la3d/formkag/blob/main/cosma/document_extraction.py#L48"
target="_blank" style="float:right; font-size:smaller">source</a>

### DocLayout

>  DocLayout (document_type:str, regions:List[__main__.Region],
>                 reading_flow:List[str]=<factory>,
>                 spatial_relationships:List[__main__.SpatialRel]=<factory>)

*Complete document layout structure including regions and their
relationships*

------------------------------------------------------------------------

<a
href="https://github.com/la3d/formkag/blob/main/cosma/document_extraction.py#L77"
target="_blank" style="float:right; font-size:smaller">source</a>

### RegionContent

>  RegionContent (content:str, concepts:List[Dict[str,str]],
>                     document_purpose:str, relationships:List[Dict[str,str]])

*Structured content extracted from a document region including semantic
information*

``` python
cache = load_cache_imgs('data/')
```

------------------------------------------------------------------------

<a
href="https://github.com/la3d/formkag/blob/main/cosma/document_extraction.py#L94"
target="_blank" style="float:right; font-size:smaller">source</a>

### parse_json

>  parse_json (s:str)

*Parse JSON from raw LLM response, handling markdown code blocks*

## Spatial Semantics and Region Extraction

In the first step of our prompt chain, we wan to extract the region
semantics

``` python
LAYOUT_PROMPT = """Analyze this document's layout structure following these specific steps.

<instructions>
1. First analyze the visual structure and spatial relationships
2. Then identify the logical reading order
3. Finally return a JSON structure describing the complete layout
</instructions>

<example>
{
    "document_type": "form",
    "layout": {
        "regions": [
            {
                "id": "r1",
                "name": "header",
                "type": "header",
                "order": 1,
                "position": "top of page"
            }
        ],
        "reading_flow": ["r1", "r2"],
        "spatial_relationships": [
            {
                "from_region": "r1",
                "to_region": "r2",
                "relationship": "above"
            }
        ]
    }
}
</example>

Return ONLY the JSON structure with no additional text."""
```

------------------------------------------------------------------------

### get_chat

>  get_chat (model:Optional[str]=None)

*Get chat instance using Cosette model infrastructure*

------------------------------------------------------------------------

### analyze_layout

>  analyze_layout (img:bytes, chat:Optional[cosette.core.Chat]=None)

*Analyze document layout using multimodal LLM*

------------------------------------------------------------------------

### extract_region_content

>  extract_region_content (img:bytes, region:__main__.Region,
>                              chat:Optional[cosette.core.Chat]=None)

*Extract content and semantic information from a specific region*

``` python
# Let's test both
layout = test_layout_analysis()
if layout: test_region_extraction(layout)
```

    Analyzing layout for 82092117.png...

    Document Type: fax_cover_sheet

    Regions:

    header (type: header)
      Position: top center

    fax_information (type: information)
      Position: below header

    recipient_information (type: recipient_info)
      Position: below fax information

    sender_information (type: sender_info)
      Position: below recipient information

    special_instructions (type: instructions)
      Position: below sender information

    note (type: note)
      Position: bottom of page

    footer (type: footer)
      Position: bottom center

    Spatial Relationships:
    • r1 above r2
    • r2 above r3
    • r3 above r4
    • r4 above r5
    • r5 above r6
    • r6 above r7

    Extracting content from header...
    Content:
    Attorney General Betty D. Montgomery

    Concepts:
    - role: Attorney General
    - identity: Betty D. Montgomery

    Purpose: Identifies the sender's office and authority responsible for the fax transmission.

    Relationships:
    - sender identity → confidential facsimile transmission cover sheet: Specifies the official sender of the document.

------------------------------------------------------------------------

### analyze_document

>  analyze_document (img_name:str, chat:Optional[cosette.core.Chat]=None)

*Complete document analysis workflow using prompt chaining*

``` python
# Run test
test_document_workflow()
```

    Testing complete workflow on 82092117.png
    ==================================================

![](00_document_extraction_files/figure-commonmark/cell-16-output-2.png)

    Step 1: Analyzing layout structure...

    Step 2: Extracting content from regions...

    Processing region 1: header

    Processing region 2: recipient_info

    Processing region 3: sender_info

    Processing region 4: special_instructions

    Processing region 5: important_notice

    {'document_type': 'fax cover sheet',
     'layout': DocLayout(document_type='fax cover sheet', regions=[
     header (type: header)
       Position: top of page, 
     recipient_info (type: section)
       Position: below header, 
     sender_info (type: section)
       Position: below recipient_info, 
     special_instructions (type: section)
       Position: below sender_info, 
     important_notice (type: notice)
       Position: bottom of page], reading_flow=['r1', 'r2', 'r3', 'r4', 'r5'], spatial_relationships=[r1 above r2, r2 above r3, r3 above r4, r4 above r5]),
     'contents': [Content:
      Attorney General Betty D. Montgomery
      
      Concepts:
      - role: Attorney General
      - identity: Betty D. Montgomery
      
      Purpose: Identifies the sender's office and authority
      
      Relationships:
      - association → content of the fax: indicates the sender responsible for the transmission,
      Content:
      TO: George Baroody
      FAX NUMBER: (336) 335-7392
      PHONE NUMBER: (336) 335-7363
      
      Concepts:
      - identity: George Baroody
      - contact: Fax Number: (336) 335-7392
      - contact: Phone Number: (336) 335-7363
      
      Purpose: Specifies the recipient's contact information for the fax transmission
      
      Relationships:
      - association → sender_info: indicates who the fax is intended for and how to contact them,
      Content:
      DATE: 12/10/98
      NUMBER OF PAGES INCLUDING COVER SHEET: 3
      SENDER/PHONE NUMBER: June Flynn for Eric Brown/(614) 466-8980
      
      Concepts:
      - date: 12/10/98
      - quantity: Number of Pages: 3
      - identity: June Flynn for Eric Brown
      - contact: Phone Number: (614) 466-8980
      
      Purpose: Provides the sender's contact information and details about the fax transmission
      
      Relationships:
      - association → recipient_info: offers sender details to complement recipient information,
      Content:
      SPECIAL INSTRUCTIONS:
      
      IF YOU DO NOT RECEIVE ANY OF THE PAGES PROPERLY, PLEASE CONTACT SENDER AS SOON AS POSSIBLE
      
      Concepts:
      - instruction: Contact sender if pages are not received properly
      
      Purpose: Provides guidance for the recipient in case of transmission issues
      
      Relationships:
      - dependency → sender_info: instructs recipient to use sender contact information if issues arise,
      Content:
      NOTE: THIS MESSAGE IS INTENDED ONLY FOR THE USE OF THE INDIVIDUAL OR ENTITY TO WHOM IT IS ADDRESSED AND MAY CONTAIN INFORMATION THAT IS PRIVILEGED, CONFIDENTIAL, AND EXEMPT FROM DISCLOSURE UNDER APPLICABLE LAW. If the reader of this message is not the intended recipient or the employee or agent responsible for delivering the message to the intended recipient, you are hereby notified that any dissemination, distribution, copying, or conveying of this communication in any manner is strictly prohibited. If you have received this communication in error, please notify us immediately by telephone and return the original message to us at the address below via the U.S. Postal Service. Thank you for your cooperation.
      
      Concepts:
      - legal_notice: Confidential and privileged communication warning
      
      Purpose: Warns and instructs unintended recipients about the legal obligations and actions to take if they receive the fax in error
      
      Relationships:
      - association → recipient_info: clarifies the intended recipient and required actions if misdelivered]}
